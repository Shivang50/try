import re


def read_file(path):
    with open(path, "r") as f:
        return f.read()


def write_file(path, content):
    with open(path, "w") as f:
        f.write(content)


def extract_complete_block(text, start_index):
    """
    Extract full {...} block safely with nested brace support.
    """
    brace_start = text.find("{", start_index)
    if brace_start == -1:
        return None, start_index

    stack = 1
    i = brace_start + 1

    while i < len(text) and stack > 0:
        if text[i] == "{":
            stack += 1
        elif text[i] == "}":
            stack -= 1
        i += 1

    return text[start_index:i], i


def get_mode_from_block(block_text):
    """
    Extract MODE name even if multiline formatted.
    """
    match = re.search(
        r'mode\s*\(\s*modes\s*,\s*"([^"]+)"\s*\)',
        block_text,
        re.DOTALL
    )
    if match:
        return match.group(1)
    return None


def should_filter_block(text, index):
    """
    Check if block starting at index is timing() or internal_power()
    """
    return (
        text.startswith("internal_power(", index)
        or text.startswith("timing(", index)
    )


def filter_lib_by_mode(text, required_mode="MODE_R1K"):
    output = []
    i = 0
    n = len(text)

    while i < n:

        if should_filter_block(text, i):

            block_text, end_index = extract_complete_block(text, i)

            if block_text is None:
                output.append(text[i])
                i += 1
                continue

            mode_value = get_mode_from_block(block_text)

            # If block has mode and matches → keep
            if mode_value == required_mode:
                output.append(block_text)

            # If block has no mode → keep (important!)
            elif mode_value is None:
                output.append(block_text)

            # else → skip block

            i = end_index
        else:
            output.append(text[i])
            i += 1

    return "".join(output)


def process_lib(input_file, output_file, required_mode="MODE_R1K"):
    content = read_file(input_file)
    filtered = filter_lib_by_mode(content, required_mode)
    write_file(output_file, filtered)
    print("Finished filtering:", output_file)


if __name__ == "__main__":
    process_lib("25C.lib", "25C_MODE_R1K.lib", "MODE_R1K")
