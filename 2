import re


def read_file(path):
    with open(path, "r") as f:
        return f.read()


def write_file(path, content):
    with open(path, "w") as f:
        f.write(content)


def extract_block(text, start):
    """
    Extract full block including nested braces.
    Returns (block_text, end_index)
    """
    brace_start = text.find("{", start)
    if brace_start == -1:
        return None, start

    depth = 1
    i = brace_start + 1

    while i < len(text) and depth > 0:
        if text[i] == "{":
            depth += 1
        elif text[i] == "}":
            depth -= 1
        i += 1

    return text[start:i], i


def get_mode(block_text):
    """
    Extract mode even if formatted with newline/backslash.
    """
    match = re.search(
        r'mode\s*\(\s*modes\s*,\s*"([^"]+)"\s*\)',
        block_text,
        re.DOTALL
    )
    if match:
        return match.group(1)
    return None


def filter_lib(text, required_mode="MODE_R1K"):
    output = []
    i = 0
    n = len(text)

    while i < n:

        # Detect internal_power or timing with flexible spacing
        if text[i:].lstrip().startswith("internal_power(") or \
           text[i:].lstrip().startswith("timing("):

            # Move i to actual keyword start
            stripped = text[i:].lstrip()
            offset = len(text[i:]) - len(stripped)
            i_actual = i + offset

            block_text, end_index = extract_block(text, i_actual)

            if block_text is None:
                output.append(text[i])
                i += 1
                continue

            mode_value = get_mode(block_text)

            # Keep block only if:
            # - mode matches required_mode
            # - OR block has no mode()
            if mode_value is None or mode_value == required_mode:
                output.append(block_text)

            # Skip this entire block
            i = end_index

        else:
            output.append(text[i])
            i += 1

    return "".join(output)


def process(input_file, output_file, required_mode="MODE_R1K"):
    content = read_file(input_file)
    filtered = filter_lib(content, required_mode)
    write_file(output_file, filtered)
    print("Filtering completed.")


if __name__ == "__main__":
    process("25C.lib", "25C_MODE_R1K.lib", "MODE_R1K")
